name: CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Grant gradlew execute permission
        run: chmod +x ./gradlew

      - name: Test
        run: ./gradlew test --no-daemon

  smoke:
    runs-on: ubuntu-latest
    needs: test
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: chatbot
          POSTGRES_USER: chatbot
          POSTGRES_PASSWORD: chatbot
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U chatbot -d chatbot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      DB_URL: jdbc:postgresql://localhost:5432/chatbot
      DB_USERNAME: chatbot
      DB_PASSWORD: chatbot
      OPENAI_API_KEY: test-openai-key
      OPENAI_MODEL: gpt-4o-mini
      APP_BOOTSTRAP_USER_ENABLED: true
      APP_BOOTSTRAP_USER_API_KEY: ci-local-api-key

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Grant gradlew execute permission
        run: chmod +x ./gradlew

      - name: Boot and smoke
        run: |
          set -euo pipefail

          ./gradlew bootRun --no-daemon > bootrun.out.log 2> bootrun.err.log &
          APP_PID=$!
          echo "${APP_PID}" > boot.pid

          for i in {1..90}; do
            if ! kill -0 "${APP_PID}" 2>/dev/null; then
              echo "bootRun process exited early"
              tail -n 200 bootrun.err.log || true
              tail -n 200 bootrun.out.log || true
              exit 1
            fi

            basic_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/health || true)
            readiness_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/actuator/health/readiness || true)

            if [ "${basic_code}" = "200" ] && [ "${readiness_code}" = "200" ]; then
              break
            fi

            if [ "$i" -eq 90 ]; then
              echo "Server did not become ready in time (health=${basic_code}, readiness=${readiness_code})"
              tail -n 200 bootrun.err.log || true
              tail -n 200 bootrun.out.log || true
              exit 1
            fi
            sleep 2
          done

          curl -sSf http://localhost:8081/health
          curl -sSf http://localhost:8081/actuator/health/readiness
          status=$(curl -s -o /tmp/conversations.json -w "%{http_code}" -H "X-API-Key: ${APP_BOOTSTRAP_USER_API_KEY}" http://localhost:8081/api/conversations)
          test "${status}" = "200"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bootrun-logs
          path: |
            bootrun.out.log
            bootrun.err.log

      - name: Stop app
        if: always()
        run: |
          if [ -f boot.pid ]; then
            kill -15 "$(cat boot.pid)" || true
          fi
