name: CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Grant gradlew execute permission
        run: chmod +x ./gradlew

      - name: Test
        run: ./gradlew test --no-daemon

  smoke:
    runs-on: ubuntu-latest
    needs: test
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: chatbot
          POSTGRES_USER: chatbot
          POSTGRES_PASSWORD: chatbot
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U chatbot -d chatbot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      DB_URL: jdbc:postgresql://localhost:5432/chatbot
      DB_USERNAME: chatbot
      DB_PASSWORD: chatbot
      OPENAI_API_KEY: test-openai-key
      OPENAI_MODEL: gpt-4o-mini
      APP_BOOTSTRAP_USER_ENABLED: true
      APP_BOOTSTRAP_USER_API_KEY: ci-local-api-key

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Grant gradlew execute permission
        run: chmod +x ./gradlew

      - name: Boot run
        run: |
          ./gradlew bootRun --no-daemon > bootrun.out.log 2> bootrun.err.log &
          echo $! > boot.pid
          sleep 20

      - name: Health check
        run: |
          curl -sSf http://localhost:8081/health
          curl -sSf http://localhost:8081/actuator/health

      - name: API smoke
        run: |
          status=$(curl -s -o /tmp/conversations.json -w "%{http_code}" -H "X-API-Key: ${APP_BOOTSTRAP_USER_API_KEY}" http://localhost:8081/api/conversations)
          test "$status" = "200"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bootrun-logs
          path: |
            bootrun.out.log
            bootrun.err.log

      - name: Stop app
        if: always()
        run: |
          if [ -f boot.pid ]; then
            kill -15 "$(cat boot.pid)" || true
          fi
